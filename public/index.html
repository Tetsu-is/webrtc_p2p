<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC P2P Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 30px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .info {
      background-color: #e7f3ff;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .info strong {
      color: #0066cc;
    }
    .status {
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-weight: bold;
    }
    .status.connected {
      background-color: #d4edda;
      color: #155724;
    }
    .status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .status.connecting {
      background-color: #fff3cd;
      color: #856404;
    }
    .peers-section {
      margin-bottom: 20px;
    }
    .peer-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .peer-item {
      padding: 10px 15px;
      background-color: #f0f0f0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .peer-item button {
      padding: 5px 10px;
      font-size: 14px;
      margin: 0;
    }
    .message-form {
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 70%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    button.success {
      background-color: #28a745;
    }
    button.success:hover {
      background-color: #218838;
    }
    .messages {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      background-color: #fafafa;
    }
    .message {
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      background-color: white;
    }
    .message.sent {
      background-color: #e3f2fd;
    }
    .message.received {
      background-color: #f1f8e9;
    }
    .message.system {
      background-color: #fff3cd;
      font-style: italic;
    }
    .video-section {
      margin-bottom: 20px;
    }
    .video-container {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .video-wrapper {
      flex: 1;
      min-width: 300px;
    }
    .video-wrapper h4 {
      margin-bottom: 10px;
      color: #333;
    }
    video {
      width: 100%;
      max-width: 100%;
      background-color: #000;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .media-controls {
      margin-bottom: 20px;
    }
    button.danger {
      background-color: #dc3545;
    }
    button.danger:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebRTC P2P通信デモ</h1>

    <div class="info">
      <strong>あなたのID:</strong> <span id="myId">接続待ち...</span>
    </div>

    <div id="signalingStatus" class="status disconnected">
      シグナリングサーバーに接続していません
    </div>

    <div id="p2pStatus" class="status disconnected">
      P2P接続していません
    </div>

    <div class="media-controls">
      <button id="startMediaButton" class="success">カメラ・音声を開始</button>
      <button id="stopMediaButton" class="danger" disabled>カメラ・音声を停止</button>
    </div>

    <div class="video-section">
      <h3>ビデオ通話</h3>
      <div class="video-container">
        <div class="video-wrapper">
          <h4>ローカルビデオ（あなた）</h4>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div class="video-wrapper">
          <h4>リモートビデオ（相手）</h4>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>
    </div>

    <div class="peers-section">
      <h3>利用可能なPeer</h3>
      <div id="peerList" class="peer-list"></div>
    </div>

    <div class="message-form">
      <input type="text" id="messageInput" placeholder="P2P接続後にメッセージを入力..." disabled>
      <button id="sendButton" disabled>送信</button>
    </div>

    <h3>メッセージ履歴</h3>
    <div id="messages" class="messages"></div>
  </div>

  <script>
    // グローバル変数
    let ws;
    let myId;
    let peerConnection;
    let dataChannel;
    let remotePeerId;
    let localStream;
    const availablePeers = new Set();

    // DOM要素
    const myIdSpan = document.getElementById('myId');
    const signalingStatusDiv = document.getElementById('signalingStatus');
    const p2pStatusDiv = document.getElementById('p2pStatus');
    const peerListDiv = document.getElementById('peerList');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const messagesDiv = document.getElementById('messages');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const startMediaButton = document.getElementById('startMediaButton');
    const stopMediaButton = document.getElementById('stopMediaButton');

    // ICEサーバー設定（STUN）
    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    // メディアストリーム（カメラ・音声）の取得
    async function startMedia() {
      try {
        startMediaButton.disabled = true;
        addMessage('カメラと音声へのアクセスを要求中...', 'system');

        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });

        localVideo.srcObject = localStream;
        startMediaButton.disabled = true;
        stopMediaButton.disabled = false;
        addMessage('カメラと音声の取得に成功しました', 'system');

        // 既存の接続がある場合、トラックを追加
        if (peerConnection) {
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
          });
        }

        console.log('ローカルストリーム取得:', localStream);
      } catch (error) {
        console.error('メディア取得エラー:', error);
        addMessage(`カメラまたは音声の取得に失敗しました: ${error.message}`, 'system');
        startMediaButton.disabled = false;
      }
    }

    // メディアストリームの停止
    function stopMedia() {
      if (localStream) {
        localStream.getTracks().forEach(track => {
          track.stop();
        });
        localVideo.srcObject = null;
        localStream = null;
        startMediaButton.disabled = false;
        stopMediaButton.disabled = true;
        addMessage('カメラと音声を停止しました', 'system');
      }
    }

    // シグナリングサーバーに接続
    function connectSignaling() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('シグナリングサーバーに接続');
        signalingStatusDiv.textContent = 'シグナリングサーバーに接続中';
        signalingStatusDiv.className = 'status connected';
        addMessage('シグナリングサーバーに接続しました', 'system');
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log('受信:', data.type, data);

        switch (data.type) {
          case 'init':
            myId = data.id;
            myIdSpan.textContent = myId;
            data.clients.forEach(id => availablePeers.add(id));
            updatePeerList();
            break;

          case 'new-client':
            availablePeers.add(data.id);
            updatePeerList();
            addMessage(`新しいPeerが参加しました: ${data.id}`, 'system');
            break;

          case 'client-disconnected':
            availablePeers.delete(data.id);
            updatePeerList();
            if (remotePeerId === data.id) {
              closeConnection();
              addMessage(`接続していたPeerが切断しました: ${data.id}`, 'system');
            }
            break;

          case 'offer':
            await handleOffer(data.offer, data.from);
            break;

          case 'answer':
            await handleAnswer(data.answer);
            break;

          case 'ice-candidate':
            await handleIceCandidate(data.candidate);
            break;
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocketエラー:', error);
        addMessage('シグナリングサーバーの接続エラー', 'system');
      };

      ws.onclose = () => {
        console.log('シグナリングサーバー切断');
        signalingStatusDiv.textContent = 'シグナリングサーバーから切断されました';
        signalingStatusDiv.className = 'status disconnected';
        addMessage('シグナリングサーバーから切断されました', 'system');
        setTimeout(connectSignaling, 3000);
      };
    }

    // Peerリストの更新
    function updatePeerList() {
      peerListDiv.innerHTML = '';
      if (availablePeers.size === 0) {
        peerListDiv.innerHTML = '<p>他のPeerが見つかりません</p>';
        return;
      }

      availablePeers.forEach(peerId => {
        const peerItem = document.createElement('div');
        peerItem.className = 'peer-item';

        const peerLabel = document.createElement('span');
        peerLabel.textContent = `Peer: ${peerId}`;

        const connectBtn = document.createElement('button');
        connectBtn.textContent = '接続';
        connectBtn.className = 'success';
        connectBtn.disabled = !!remotePeerId;
        connectBtn.onclick = () => createOffer(peerId);

        peerItem.appendChild(peerLabel);
        peerItem.appendChild(connectBtn);
        peerListDiv.appendChild(peerItem);
      });
    }

    // P2P接続の開始（Offer作成）
    async function createOffer(peerId) {
      try {
        remotePeerId = peerId;
        addMessage(`${peerId}への接続を開始...`, 'system');
        p2pStatusDiv.textContent = 'P2P接続を確立中...';
        p2pStatusDiv.className = 'status connecting';

        // PeerConnectionの作成
        peerConnection = new RTCPeerConnection(configuration);
        setupPeerConnection();

        // ローカルストリームがある場合、トラックを追加
        if (localStream) {
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
            console.log('トラックを追加:', track.kind);
          });
        }

        // データチャネルの作成（Offer側が作成）
        dataChannel = peerConnection.createDataChannel('chat');
        setupDataChannel();

        // Offerの作成
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Offerの送信
        ws.send(JSON.stringify({
          type: 'offer',
          offer: offer,
          target: peerId
        }));

        console.log('Offerを送信:', peerId);
      } catch (error) {
        console.error('Offer作成エラー:', error);
        addMessage('接続の開始に失敗しました', 'system');
      }
    }

    // Offerの受信と処理
    async function handleOffer(offer, from) {
      try {
        remotePeerId = from;
        addMessage(`${from}から接続リクエストを受信`, 'system');
        p2pStatusDiv.textContent = 'P2P接続を確立中...';
        p2pStatusDiv.className = 'status connecting';

        // PeerConnectionの作成
        peerConnection = new RTCPeerConnection(configuration);
        setupPeerConnection();

        // ローカルストリームがある場合、トラックを追加
        if (localStream) {
          localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
            console.log('トラックを追加:', track.kind);
          });
        }

        // リモートディスクリプションの設定
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

        // Answerの作成
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        // Answerの送信
        ws.send(JSON.stringify({
          type: 'answer',
          answer: answer,
          target: from
        }));

        console.log('Answerを送信:', from);
      } catch (error) {
        console.error('Offer処理エラー:', error);
        addMessage('接続の受け入れに失敗しました', 'system');
      }
    }

    // Answerの受信と処理
    async function handleAnswer(answer) {
      try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        console.log('Answerを受信し、リモートディスクリプションを設定');
      } catch (error) {
        console.error('Answer処理エラー:', error);
      }
    }

    // ICE Candidateの受信と処理
    async function handleIceCandidate(candidate) {
      try {
        if (candidate) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          console.log('ICE Candidateを追加');
        }
      } catch (error) {
        console.error('ICE Candidate追加エラー:', error);
      }
    }

    // PeerConnectionのセットアップ
    function setupPeerConnection() {
      // ICE候補の送信
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: 'ice-candidate',
            candidate: event.candidate,
            target: remotePeerId
          }));
          console.log('ICE Candidateを送信');
        }
      };

      // 接続状態の監視
      peerConnection.onconnectionstatechange = () => {
        console.log('接続状態:', peerConnection.connectionState);
        if (peerConnection.connectionState === 'connected') {
          p2pStatusDiv.textContent = `P2P接続確立: ${remotePeerId}`;
          p2pStatusDiv.className = 'status connected';
          addMessage(`P2P接続が確立しました: ${remotePeerId}`, 'system');
          updatePeerList();
        } else if (peerConnection.connectionState === 'disconnected' ||
                   peerConnection.connectionState === 'failed') {
          closeConnection();
        }
      };

      // リモートトラックの受信
      peerConnection.ontrack = (event) => {
        console.log('リモートトラックを受信:', event.track.kind);
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          addMessage(`リモートの${event.track.kind === 'video' ? 'ビデオ' : '音声'}トラックを受信しました`, 'system');
        }
      };

      // データチャネルの受信（Answer側）
      peerConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel();
      };
    }

    // データチャネルのセットアップ
    function setupDataChannel() {
      dataChannel.onopen = () => {
        console.log('データチャネルが開きました');
        messageInput.disabled = false;
        sendButton.disabled = false;
        addMessage('データチャネルが開きました。メッセージを送信できます。', 'system');
      };

      dataChannel.onmessage = (event) => {
        console.log('P2Pメッセージ受信:', event.data);
        addMessage(`受信: ${event.data}`, 'received');
      };

      dataChannel.onclose = () => {
        console.log('データチャネルが閉じました');
        messageInput.disabled = true;
        sendButton.disabled = true;
      };
    }

    // メッセージ送信
    function sendMessage() {
      const message = messageInput.value.trim();
      if (message && dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(message);
        addMessage(`送信: ${message}`, 'sent');
        messageInput.value = '';
      }
    }

    // 接続のクローズ
    function closeConnection() {
      if (dataChannel) {
        dataChannel.close();
        dataChannel = null;
      }
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      remoteVideo.srcObject = null;
      remotePeerId = null;
      messageInput.disabled = true;
      sendButton.disabled = true;
      p2pStatusDiv.textContent = 'P2P接続していません';
      p2pStatusDiv.className = 'status disconnected';
      updatePeerList();
    }

    // メッセージ表示
    function addMessage(text, type) {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${type}`;
      messageElement.textContent = text;
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // イベントリスナー
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    startMediaButton.addEventListener('click', startMedia);
    stopMediaButton.addEventListener('click', stopMedia);

    // 初期接続
    connectSignaling();
  </script>
</body>
</html>
